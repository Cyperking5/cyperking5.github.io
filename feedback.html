<!-- ab <script type="module"> unten ist das relevante Update -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref, push, get, child } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCfS9qn-B8MZx8gHs7a_TiU8TY5LROeFCA",
    authDomain: "adblocker-feedback.firebaseapp.com",
    databaseURL: "https://adblocker-feedback-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "adblocker-feedback",
    storageBucket: "adblocker-feedback.appspot.com",
    messagingSenderId: "504023672779",
    appId: "1:504023672779:web:cf6a9fd51a8f870ae7384e",
    measurementId: "G-DHFRDS6E62"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let selectedRating = 0;

  document.querySelectorAll('.star').forEach(star => {
    star.addEventListener('click', function () {
      selectedRating = this.getAttribute('data-value');
      document.querySelectorAll('.star').forEach(s => s.classList.remove('selected'));
      for (let i = 0; i < selectedRating; i++) {
        document.querySelectorAll('.star')[i].classList.add('selected');
      }
    });
  });

  window.submitFeedback = function () {
    const comment = document.getElementById('comment').value.trim();

    if (localStorage.getItem("feedbackSent") === "true") {
      alert("Du hast bereits Feedback abgegeben.");
      return;
    }

    if (selectedRating === 0 || comment === '') {
      alert('Bitte Bewertung und Kommentar angeben.');
      return;
    }

    grecaptcha.ready(() => {
      grecaptcha.execute('6Lft-pUrAAAAALokbwg3S8c27oJggzuHSnjlDoh4', { action: 'submit_feedback' }).then(token => {
        push(ref(db, 'feedbacks'), {
          rating: selectedRating,
          comment: comment,
          created_at: new Date().toISOString(),
          recaptcha_token: token
        }).then(() => {
          localStorage.setItem("feedbackSent", "true");
          document.getElementById('comment').value = '';
          selectedRating = 0;
          document.querySelectorAll('.star').forEach(s => s.classList.remove('selected'));
          loadFeedback();
          alert("Vielen Dank für dein Feedback!");
        });
      });
    });
  }

  function loadFeedback() {
    get(child(ref(db), 'feedbacks')).then(snapshot => {
      const feedbackList = document.getElementById('feedback-list');
      feedbackList.innerHTML = '<h2>Recent Feedback</h2>';
      const data = snapshot.val();
      if (!data) return;

      const ratings = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
      let total = 0;
      let sum = 0;

      Object.values(data).reverse().forEach(item => {
        const r = parseInt(item.rating);
        if (ratings[r] !== undefined) {
          ratings[r]++;
          total++;
          sum += r;
        }

        const div = document.createElement('div');
        div.className = 'feedback-item';
        div.innerHTML = `
          <div class="stars">${'★'.repeat(item.rating)}${'☆'.repeat(5 - item.rating)}</div>
          <div>${item.comment}</div>
          <small>${new Date(item.created_at).toLocaleString()}</small>
        `;
        feedbackList.appendChild(div);
      });

      updateRatingSummary(ratings, total, sum);
    });
  }

  function updateRatingSummary(ratings, total, sum) {
    const avg = total > 0 ? (sum / total) : 0;

    document.getElementById('avg-rating').textContent = avg.toFixed(1).replace('.', ',');
    document.getElementById('total-ratings').textContent = `${total.toLocaleString()} Bewertungen`;

    const starsEl = document.getElementById('avg-stars');
    starsEl.innerHTML = '';
    const fullStars = Math.floor(avg);
    const halfStar = avg - fullStars >= 0.5;
    for (let i = 0; i < 5; i++) {
      const star = document.createElement('span');
      star.innerHTML = i < fullStars ? '★' : (i === fullStars && halfStar ? '⯨' : '☆');
      star.style.color = '#fbbf24';
      star.style.fontSize = '1.5rem';
      starsEl.appendChild(star);
    }

    const barsEl = document.getElementById('rating-bars');
    barsEl.innerHTML = '';
    const totalVotes = total || 1;

    for (let i = 5; i >= 1; i--) {
      const count = ratings[i] || 0;
      const percentage = (count / totalVotes) * 100;

      const bar = document.createElement('div');
      bar.className = 'rating-bar';
      bar.innerHTML = `
        <span>${i}</span>
        <div class="bar">
          <div class="fill" style="width: ${percentage}%; background-color: #60a5fa;"></div>
        </div>
      `;
      barsEl.appendChild(bar);
    }
  }

  window.onload = loadFeedback;
          </script>
